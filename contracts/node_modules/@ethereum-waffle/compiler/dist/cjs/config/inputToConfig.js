"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const defaultConfig_1 = require("./defaultConfig");
const deprecate_1 = require("../deprecate");
function inputToConfig(input) {
    const result = { ...defaultConfig_1.defaultConfig };
    function set(key, value) {
        result[key] = value;
    }
    for (const key in input) {
        if (input[key] != null) {
            if (key in defaultConfig_1.defaultConfig) {
                set(key, input[key]);
            }
            else if (key === 'sourcesPath') {
                deprecate_1.deprecate('sourcesPath', 'Use sourceDirectory instead.');
                set('sourceDirectory', input[key]);
            }
            else if (key === 'targetPath') {
                deprecate_1.deprecate('targetPath', 'Use outputDirectory instead.');
                set('outputDirectory', input[key]);
            }
            else if (key === 'npmPath') {
                deprecate_1.deprecate('npmPath', 'Use nodeModulesDirectory instead.');
                set('nodeModulesDirectory', input[key]);
            }
            else if (key === 'compiler') {
                deprecate_1.deprecate('compiler', 'Use compilerType instead.');
                set('compilerType', input[key]);
            }
            else if (key === 'docker-tag') {
                deprecate_1.deprecate('docker-tag', 'Use compilerVersion instead.');
                set('compilerVersion', input[key]);
            }
            else if (key === 'solcVersion') {
                deprecate_1.deprecate('solcVersion', 'Use compilerVersion instead.');
                set('compilerVersion', input[key]);
            }
            else if (key === 'allowedPaths') {
                deprecate_1.deprecate('allowedPaths', 'Use compilerAllowedPaths instead.');
                set('compilerAllowedPaths', input[key]);
            }
            else if (key === 'legacyOutput') {
                deprecate_1.deprecate('legacyOutput', 'It was always enabled anyway.');
            }
            else if (key === 'ganacheOptions') {
                deprecate_1.deprecate('ganacheOptions', 'It has no effect on the compiler.');
            }
        }
    }
    validate(result);
    return result;
}
exports.inputToConfig = inputToConfig;
function validate(config) {
    function checkConfigProperty(property, validator) {
        if (!validator(config[property])) {
            throw new TypeError(`Invalid config. Check the value of "${property}"`);
        }
    }
    checkConfigProperty('sourceDirectory', checkSourceDirectory);
    checkConfigProperty('outputDirectory', checkOutputDirectory);
    checkConfigProperty('flattenOutputDirectory', checkFlattenOutputDirectory);
    checkConfigProperty('nodeModulesDirectory', checkNodeModulesDirectory);
    checkConfigProperty('compilerType', checkCompilerType);
    checkConfigProperty('compilerVersion', checkCompilerVersion);
    checkConfigProperty('compilerAllowedPaths', checkCompilerAllowedPaths);
    checkConfigProperty('compilerOptions', checkCompilerOptions);
    checkConfigProperty('outputHumanReadableAbi', checkOutputHumanReadableAbi);
    checkConfigProperty('outputType', checkOutputType);
}
const checkSourceDirectory = checkType('sourceDirectory', 'string');
const checkOutputDirectory = checkType('outputDirectory', 'string');
const checkFlattenOutputDirectory = checkType('flattenOutputDirectory', 'string');
const checkNodeModulesDirectory = checkType('nodeModulesDirectory', 'string');
const checkCompilerType = checkEnum('compilerType', ['native', 'dockerized-solc', 'solcjs', 'dockerized-vyper']);
const checkCompilerVersion = checkType('compilerVersion', 'string');
function checkCompilerAllowedPaths(compilerAllowedPaths) {
    if (!Array.isArray(compilerAllowedPaths)) {
        console.warn('Warning: compilerAllowedPaths must be string[], but is not an array');
        return false;
    }
    else if (compilerAllowedPaths.some(x => typeof x !== 'string')) {
        console.warn('Warning: compilerAllowedPaths must be string[], but some of the values are not strings');
        return false;
    }
    return true;
}
const checkCompilerOptions = checkType('compilerOptions', 'object');
const checkOutputHumanReadableAbi = checkType('outputHumanReadableAbi', 'boolean');
const checkOutputType = checkEnum('outputType', ['multiple', 'combined', 'all']);
function checkType(key, type) {
    return function (value) {
        if (typeof value !== type) { // eslint-disable-line valid-typeof
            console.warn(`Warning: "${key}" must have type of ${type}. Received: ${typeof value}.`);
            return false;
        }
        return true;
    };
}
function checkEnum(key, values) {
    return function (value) {
        if (!values.includes(value)) {
            console.warn(`Warning: ${key} must be one of: ${values.join(', ')}. Received: ${value}.`);
            return false;
        }
        return true;
    };
}
